generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @db.VarChar(255)
  slug            String   @unique @db.VarChar(255)
  apiKeyHash      String   @unique @map("api_key_hash") @db.VarChar(255)
  plan            String   @default("FREE") @db.VarChar(50)
  rateLimitPerMin Int      @default(100) @map("rate_limit_per_min")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  users           User[]
  events          TelemetryEvent[]
  
  @@index([apiKeyHash], map: "idx_organizations_api_key")
  @@index([plan], map: "idx_organizations_plan")
  @@map("organizations")
}

model User {
  id               String      @id @default(cuid())
  email            String      @unique @db.VarChar(255)
  passwordHash     String?     @map("password_hash") @db.VarChar(255)
  name             String?     @db.VarChar(255)
  googleId         String?     @unique @map("google_id") @db.VarChar(255)
  githubId         String?     @unique @map("github_id") @db.VarChar(255)
  apiKey           String      @unique @map("api_key") @db.VarChar(255)
  plan             String      @default("free") @db.VarChar(50)
  usageLimit       Int         @default(100) @map("usage_limit")
  usageCount       Int         @default(0) @map("usage_count")
  stripeCustomerId String?     @unique @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId String? @map("stripe_subscription_id") @db.VarChar(255)
  emailVerified    Boolean     @default(false) @map("email_verified")
  verificationToken String?    @map("verification_token") @db.VarChar(255)
  resetToken       String?     @map("reset_token") @db.VarChar(255)
  resetTokenExpiry DateTime?   @map("reset_token_expiry") @db.Timestamptz(6)
  organizationId   String?     @map("organization_id") @db.Uuid
  createdAt        DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  organization     Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  agents           Agent[]
  workflows        Workflow[]
  executions       Execution[]
  budgets          Budget[]

  @@index([email], map: "idx_users_email")
  @@index([apiKey], map: "idx_users_api_key")
  @@index([plan], map: "idx_users_plan")
  @@index([googleId], map: "idx_users_google_id")
  @@index([githubId], map: "idx_users_github_id")
  @@index([organizationId], map: "idx_users_organization_id")
  @@map("users")
}

model Agent {
  id         String      @id @db.Uuid
  userId     String      @map("user_id")
  name       String      @db.VarChar(255)
  model      String      @db.VarChar(255)
  config     Json        @default("{}")
  createdAt  DateTime?   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime?   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  executions Execution[]
  logs       Log[]

  @@index([userId], map: "idx_agents_user_id")
  @@map("agents")
}

model Execution {
  id          String    @id @db.Uuid
  userId      String    @map("user_id")
  agentId     String?   @map("agent_id") @db.Uuid
  status      String    @db.VarChar(50)
  input       Json?
  output      Json?
  error       String?
  startedAt   DateTime? @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  durationMs  Int?      @map("duration_ms")
  costs       Cost[]
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent       Agent?    @relation(fields: [agentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  logs        Log[]
  traces      Trace[]

  @@index([userId], map: "idx_executions_user_id")
  @@index([agentId], map: "idx_executions_agent_id")
  @@index([status], map: "idx_executions_status")
  @@index([startedAt], map: "idx_executions_started_at")
  @@index([agentId, status], map: "idx_executions_agent_status")
  @@map("executions")
}

model Log {
  id          String     @id @db.Uuid
  executionId String?    @map("execution_id") @db.Uuid
  agentId     String?    @map("agent_id") @db.Uuid
  level       String     @db.VarChar(20)
  message     String
  metadata    Json?
  timestamp   DateTime?  @default(now()) @db.Timestamptz(6)
  agent       Agent?     @relation(fields: [agentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  execution   Execution? @relation(fields: [executionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([executionId], map: "idx_logs_execution_id")
  @@index([agentId], map: "idx_logs_agent_id")
  @@index([timestamp], map: "idx_logs_timestamp")
  @@index([level], map: "idx_logs_level")
  @@index([executionId, timestamp], map: "idx_logs_exec_time")
  @@index([executionId, timestamp(sort: Desc), level], map: "idx_logs_composite")
  @@index([agentId, timestamp(sort: Desc)], map: "idx_logs_agent_timestamp")
  @@map("logs")
}

model Trace {
  id          String     @id @db.Uuid
  executionId String?    @map("execution_id") @db.Uuid
  treeData    Json       @map("tree_data")
  metadata    Json?
  createdAt   DateTime?  @default(now()) @map("created_at") @db.Timestamptz(6)
  execution   Execution? @relation(fields: [executionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([executionId], map: "idx_traces_execution_id")
  @@map("traces")
}

model Cost {
  id               String     @id @db.Uuid
  executionId      String?    @map("execution_id") @db.Uuid
  model            String     @db.VarChar(255)
  promptTokens     Int        @default(0) @map("prompt_tokens")
  completionTokens Int        @default(0) @map("completion_tokens")
  totalTokens      Int        @default(0) @map("total_tokens")
  cost             Decimal    @default(0) @db.Decimal(10, 6)
  currency         String?    @default("USD") @db.VarChar(10)
  createdAt        DateTime?  @default(now()) @map("created_at") @db.Timestamptz(6)
  execution        Execution? @relation(fields: [executionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([executionId], map: "idx_costs_execution_id")
  @@index([model], map: "idx_costs_model")
  @@index([createdAt], map: "idx_costs_created_at")
  @@index([model, createdAt], map: "idx_costs_model_date")
  @@map("costs")
}

model Workflow {
  id          String    @id @db.Uuid
  userId      String    @map("user_id")
  name        String    @db.VarChar(255)
  description String?
  definition  Json
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name], map: "idx_workflows_user_name")
  @@index([userId], map: "idx_workflows_user_id")
  @@map("workflows")
}

model Budget {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id")
  name          String    @db.VarChar(255)
  limitAmount   Decimal   @map("limit_amount") @db.Decimal(10, 2)
  period        String    @db.VarChar(20)
  scope         String    @db.VarChar(50)
  scopeId       String?   @map("scope_id") @db.VarChar(255)
  currentSpend  Decimal   @default(0) @map("current_spend") @db.Decimal(10, 6)
  hardLimit     Boolean   @default(true) @map("hard_limit")
  alertAt       Int       @default(80) @map("alert_at")
  alert80Sent   Boolean   @default(false) @map("alert_80_sent")
  alert100Sent  Boolean   @default(false) @map("alert_100_sent")
  status        String    @default("active") @db.VarChar(20)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_budgets_user_id")
  @@index([status], map: "idx_budgets_status")
  @@index([scope, scopeId], map: "idx_budgets_scope")
  @@map("budgets")
}

model AlertLog {
  id          String    @id @default(uuid()) @db.Uuid
  budgetId    String    @map("budget_id") @db.Uuid
  alertType   String    @map("alert_type") @db.VarChar(50)
  channel     String    @db.VarChar(50)
  recipient   String    @db.VarChar(255)
  message     String
  sentAt      DateTime  @default(now()) @map("sent_at") @db.Timestamptz(6)
  success     Boolean   @default(true)
  error       String?

  @@index([budgetId], map: "idx_alert_logs_budget_id")
  @@index([sentAt], map: "idx_alert_logs_sent_at")
  @@map("alert_logs")
}

model TelemetryEvent {
  id               String       @id @default(uuid()) @db.Uuid
  organizationId   String       @map("organization_id") @db.Uuid
  timestamp        DateTime     @db.Timestamptz(6)
  provider         String       @db.VarChar(50)
  model            String       @db.VarChar(255)
  promptTokens     Int          @map("prompt_tokens")
  completionTokens Int          @map("completion_tokens")
  totalTokens      Int          @map("total_tokens")
  cost             Decimal      @db.Decimal(10, 6)
  latency          Int
  status           String       @db.VarChar(20)
  error            String?
  createdAt        DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId, timestamp], map: "idx_telemetry_org_time")
  @@index([provider, model], map: "idx_telemetry_provider_model")
  @@index([status], map: "idx_telemetry_status")
  @@index([createdAt], map: "idx_telemetry_created_at")
  @@map("telemetry_events")
}
